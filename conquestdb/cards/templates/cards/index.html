{% extends "base.html" %}
{% block title %}Card Search{% endblock %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'card_search_style.css' %}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<datalist id="traitsList">
    {% for trait in traits_list %}
        <option value="{{ trait }}"></option>
    {% endfor %}
</datalist>
<body>
    <div class="filters-container">
        <form id="myForm">
            <div class="ranges-grid">
                <p id="p-card-name">Card Name:</p><input id="searchInput" type="text" name="search">
                <p id="p-traits">Traits:</p><input id="traitsInput" type="text" name="traits" autocomplete="off" list="traitsList">
                <p id="p-card-type">Card Type:</p><select name="card-type" id="cardType">
                        <option value="None"></option>
                        <option value="Army">Army</option>
                        <option value="Support">Support</option>
                        <option value="Event">Event</option>
                        <option value="Attachment">Attachment</option>
                        <option value="Warlord">Warlord</option>
                        <option value="Synapse">Synapse</option>
                        <option value="Token">Token</option>
                        <option value="Planet">Planet</option>
                    </select>
                <p id="p-faction">Faction:</p><select name="faction" id="faction">
                        <option value="None"></option>
                        <option value="Space Marines">Space Marines</option>
                        <option value="Tau">Tau</option>
                        <option value="Eldar">Eldar</option>
                        <option value="Dark Eldar">Dark Eldar</option>
                        <option value="Chaos">Chaos</option>
                        <option value="Orks">Orks</option>
                        <option value="Astra Militarum">Astra Militarum</option>
                        <option value="Neutral">Neutral</option>
                        <option value="Tyranids">Tyranids</option>
                        <option value="Necrons">Necrons</option>
                    </select>
                <p id="p-loyalty">Loyalty:</p><select name="loyalty" id="loyalty">
                        <option value="None"></option>
                        <option value="Common">Common</option>
                        <option value="Loyal">Loyal</option>
                        <option value="Signature">Signature</option>
                     </select>
                <p id="p-shields">Shields:</p><select name="shields" id="shields">
                        <option value="-1"></option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                <p id="min-cost">Minimum Cost:</p><input id="minCost" type="text" name="minCost">
                <p id="max-cost">Maximum Cost:</p><input id="maxCost" type="text" name="maxCost">
                <p id="min-command">Minimum Command Icons:</p><input id="minCommand" type="text" name="minCommand">
                <p id="max-command">Maximum Command Icons:</p><input id="maxCommand" type="text" name="maxCommand">
                <p id="min-attack">Minimum Attack:</p><input id="minAttack" type="text" name="minAttack">
                <p id="max-attack">Maximum Attack:</p><input id="maxAttack" type="text" name="maxAttack">
                <p id="min-health">Minimum Health:</p><input id="minHealth" type="text" name="minHealth">
                <p id="max-health">Maximum Health:</p><input id="maxHealth" type="text" name="maxHealth">
                <p id="p-war-pack">War Pack:</p><select name="war-pack" id="war-pack">
                        <option value=""></option>
                        {% for warpack_name in warpacks_list %}
                            <option value="{{ warpack_name }}">{{ warpack_name }}</option>
                        {% endfor %}
                    </select>
                <p id="p-cycle">Cycle:</p><select name="cycle" id="cycle">
                        <option value=""></option>
                        {% for cycle_name in cycles_list %}
                            <option value="{{ cycle_name }}">{{ cycle_name }}</option>
                        {% endfor %}
                    </select>
                <p id="p-keyword" class="filter">Keyword or Specialization:</p><select name="keyword" class="filter" id="keywordInput">
                    <option value="None"></option>
                    <option value="No Attachments">No Attachments</option>
                    <option value="No Wargear Attachments">No Wargear Attachments</option>
                    <option value="Armorbane">Armorbane</option>
                    <option value="Brutal">Brutal</option>
                    <option value="Limited">Limited</option>
                    <option value="Flying">Flying</option>
                    <option value="Area Effect">Area Effect</option>
                    <option value="Ranged">Ranged</option>
                    <option value="Ambush">Ambush</option>
                    <option value="Deep Strike">Deep Strike</option>
                    <option value="Lumbering">Lumbering</option>
                    <option value="Sweep">Sweep</option>
                    <option value="Retaliate">Retaliate</option>
                    <option value="Hive Mind">Hive Mind</option>
                    <option value="Unstoppable">Unstoppable</option>
                    <option value="Goes Fasta">Goes Fasta!</option>
                    <option value="Bloodthirst">Bloodthirst</option>
                </select>
                <p id="p-sector" class="filter">Sector: (if planet)</p><select name="sector" class="filter" id="sector">
                    <option value=""></option>
                    <option value="Traxis">Traxis</option>
                    <option value="Gardis">Gardis</option>
                    <option value="Veros">Veros</option>
                    <option value="The Breach">The Breach</option>
                    <option value="Nepthis">Nepthis</option>
                    <option value="Sargos">Sargos</option>
                </select>
                <p id="p-order" class="filter">Order By:</p><select name="order" class="filter" id="order">
                    <option value="None"></option>
                    <option value="Name">Name</option>
                    <option value="Card Type">Card Type</option>
                    <option value="COST">Cost</option>
                    <option value="Attack">ATK</option>
                    <option value="Health">HP</option>
                    <option value="Command">Command</option>
                    <option value="Shields">Shields</option>
                    <option value="War Pack">War Pack</option>
                    <option value="Cycle">Cycle</option>
                </select>
                <p id="p-asc-desc" class="filter">Asc./Desc.:</p><select name="asc-desc" class="filter" id="asc-desc">
                    <option value="Ascending" selected="selected">Ascending</option>
                    <option value="Descending">Descending</option>
                </select>
            </div>
            <div id="buttons-container">
                <button type="submit" id="submit">Perform Search</button>
                <button id="clear-filter" onclick="clearFilters();">Reset Filters</button>
                <h3 id="view-as">View as: </h3><select name="view-as-selector" id="view-as-selector">
                    <option value="Images" selected="selected">Images</option>
                    <option value="Rows">Rows</option>
                </select>
            </div>
        </form>
    </div>
    <div id="cardBinderContainer">
        <input id="prev-page" type="button" value="previous" onclick="previousPage();">
        <div id="cardBinder">
            <div id="responseMessage">
                <div class="page" id="page"></div>
            </div>
        </div>
        <input id="next-page" type="button" value="next" onclick="nextPage();">
    </div>
    <div id="card-counts-pages">
        <p>Showing 0-0 of 0 matches</p>
    </div>
    <div class="center" style="display:none">
        Number of rows per page:<select name="num-rows" class="num-rows" id="num-rows" onchange="updateMaxRows(this)">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20" selected="selected">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="500">500</option>
            <option value="1000">1000</option>
            <option value="2000">2000</option>
        </select>
    </div>
    <script>
        var current_page_number = 0;
        var max_page_number = 0;
        var max_rows = "20";
        var current_max_rows = 20;
        var num_matches = 0;
        var current_low_match = 0;
        var current_high_match = 0;
        var stored_image_links = [];
        var stored_image_names = [];

        function clearFilters() {
            var searchInput = document.getElementById("searchInput");
            searchInput.value = "";
            var searchInput = document.getElementById("loyalty");
            searchInput.value = "None";
            var searchInput = document.getElementById("faction");
            searchInput.value = "None";
            var searchInput = document.getElementById("cardType");
            searchInput.value = "None";
            var searchInput = document.getElementById("traitsInput");
            searchInput.value = "";
            var searchInput = document.getElementById("shields");
            searchInput.value = "-1";
            var searchInput = document.getElementById("minCost");
            searchInput.value = "";
            var searchInput = document.getElementById("maxCost");
            searchInput.value = "";
            var searchInput = document.getElementById("minCommand");
            searchInput.value = "";
            var searchInput = document.getElementById("maxCommand");
            searchInput.value = "";
            var searchInput = document.getElementById("minAttack");
            searchInput.value = "";
            var searchInput = document.getElementById("maxAttack");
            searchInput.value = "";
            var searchInput = document.getElementById("minHealth");
            searchInput.value = "";
            var searchInput = document.getElementById("maxHealth");
            searchInput.value = "";
            var searchInput = document.getElementById("cycle");
            searchInput.value = "None";
            var searchInput = document.getElementById("war-pack");
            searchInput.value = "None";
        }

        function updateMaxRows(e) {
            max_rows = e.value;
        }

        function previousPage() {
            if (current_page_number !== 0) {
                current_page_number = current_page_number - 1;
                current_low_match = current_low_match - current_max_rows;
                current_high_match = (current_page_number + 1) * current_max_rows;
                page_counter = document.getElementById("card-counts-pages");
                page_counter.innerHTML = `<p>Showing ` + current_low_match + `-` + current_high_match + ` of ` + num_matches + ` matches</p>`;
                e = document.getElementById("responseMessage");
                e.innerHTML = ``;
                var img_src = "";
                var img_link = "";
                var new_string = "";
                var new_id = "";
                new_string += `<div class="page" id="page">`;
                for (let i = 0; i < stored_image_links[current_page_number].length; i++) {
                    img_link = stored_image_links[current_page_number][i];
                    new_string += `<a href=`;
                    new_string += img_link;
                    new_string += `>`;
                    img_src = stored_image_names[current_page_number][i];
                    new_string += `<img class="Card" src=` + img_src + ` alt="Loading...">`;
                    new_string += `</a>`;
                }
                new_string += `</div>`;
                e.innerHTML += new_string;
            }
        }

        function nextPage() {
            if (current_page_number !== max_page_number) {
                current_page_number = current_page_number + 1;
                e = document.getElementById("responseMessage");
                e.innerHTML = ``;
                current_low_match = current_low_match + current_max_rows;
                current_high_match = (current_page_number + 1) * current_max_rows;
                if (current_high_match > num_matches) {
                    current_high_match = num_matches;
                }
                page_counter = document.getElementById("card-counts-pages");
                page_counter.innerHTML = `<p>Showing ` + current_low_match + `-` + current_high_match + ` of ` + num_matches + ` matches</p>`;
                var img_src = "";
                var img_link = "";
                var new_string = "";
                var new_id = "";
                new_string += `<div class="page" id="page">`;
                for (let i = 0; i < stored_image_links[current_page_number].length; i++) {
                    img_link = stored_image_links[current_page_number][i];
                    new_string += `<a href=`;
                    new_string += img_link;
                    new_string += `>`;
                    img_src = stored_image_names[current_page_number][i];
                    new_string += `<img class="Card" src=` + img_src + ` alt="Loading...">`;
                    new_string += `</a>`;
                }
                new_string += `</div>`;
                e.innerHTML += new_string;
            }
        }

        // Ajax setup for form submission
        $(document).ready(function() {
            $('#myForm').on('submit', function(event) {
                event.preventDefault();

                $.ajax({
                    url: '/cards/ajax/',  // The URL of the Django view that handles the request
                    type: 'POST',
                    data: {
                        'search': $('#searchInput').val(),
                        'faction': $('#faction').val(),
                        'card_type': $('#cardType').val(),
                        'loyalty': $('#loyalty').val(),
                        'traits': $('#traitsInput').val(),
                        'shields': $('#shields').val(),
                        'min-cost': $('#minCost').val(),
                        'max-cost': $('#maxCost').val(),
                        'keyword': $('#keywordInput').val(),
                        'sector': $('#sector').val(),
                        'min-command': $('#minCommand').val(),
                        'max-command': $('#maxCommand').val(),
                        'min-attack': $('#minAttack').val(),
                        'max-attack': $('#maxAttack').val(),
                        'min-health': $('#minHealth').val(),
                        'max-health': $('#maxHealth').val(),
                        'war-pack': $('#war-pack').val(),
                        'cycle': $('#cycle').val(),
                        'redirect-enabled': "Yes",
                        'order': $('#order').val(),
                        'asc': $('#asc-desc').val(),
                        'view-as': $('#view-as-selector').val(),
                        'csrfmiddlewaretoken': '{{ csrf_token }}' // CSRF token for security
                    },
                    success: function(response) {
                        $('#responseMessage').text(response.message);  // Update the page dynamically
                        const message = response.message;
                        if (message === "REDIRECT") {
                            location.href = "/cards/" + response.image_names[0] + "/";
                        }
                        current_page_number = 0;
                        var cardCount = 0;
                        var pageCount = 0;
                        var card_names = response.cards;
                        const image_names = response.image_names;
                        e = document.getElementById("responseMessage");
                        e.innerHTML = ``;
                        var img_src = "";
                        var img_link = "";
                        var new_string = "";
                        var new_id = "";
                        new_string += `<div class="page" id="page">`;
                        stored_image_links = [[]];
                        stored_image_names = [[]];
                        current_max_rows = parseInt(max_rows);
                        num_matches = image_names.length;
                        current_low_match = 1;
                        if (num_matches === 0) {
                            current_low_match = 0;
                        }
                        current_high_match = current_max_rows;
                        if (current_high_match > num_matches) {
                            current_high_match = num_matches;
                        }
                        page_counter = document.getElementById("card-counts-pages");
                        page_counter.innerHTML = `<p>Showing ` + current_low_match + `-` + current_high_match + ` of ` + num_matches + ` matches</p>`;
                        for (let i = 0; i < image_names.length; i++) {
                            if (cardCount === 20) {
                                pageCount += 1
                                cardCount = 0;
                                stored_image_links.push([]);
                                stored_image_names.push([]);
                                // new_id = "page-" + pageCount.toString();
                                // new_string += `</div><div class="page" style="display: none;" id=` + new_id + `>`;
                            }
                            img_link = "/cards/" + image_names[i] + "/";
                            stored_image_links[pageCount].push(img_link);
                            img_src ="/static/images/CardImages/" + image_names[i] + ".jpg";
                            stored_image_names[pageCount].push(img_src);
                            if (pageCount === 0) {
                                new_string += `<a href=`
                                new_string += img_link;
                                new_string += `>`;
                                new_string += `<img class="Card" src=` + img_src + ` alt="Loading...">`;
                                new_string += `</a>`;
                            }
                            cardCount += 1;
                        }
                        max_page_number = pageCount;
                        new_string += `</div>`;
                        // console.log(stored_image_links);
                        e.innerHTML += new_string;
                    }
                });
            });
        });
    </script>
{% endblock %}
